// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  PARTICIPANT
  COUNTER
}

enum MajorityType {
  QUALIFIED
  SIMPLE
}

enum Status {
  UPCOMING
  ONGOING
  ENDED
}

model User {
  id            String        @id @default(uuid()) @db.Uuid
  email         String        @unique @db.VarChar(255)
  emailVerified Boolean       @default(false)
  password      String
  meetings      Meeting[]
  participantAt Participant[]
}

model Meeting {
  id           String        @id @default(uuid()) @db.Uuid
  title        String        @db.VarChar(255)
  startTime    DateTime
  description  String
  owner        User          @relation(fields: [ownerId], references: [id])
  ownerId      String        @db.Uuid
  votations    Votation[]
  status       Status        @db.default(UPCOMING)
  participants Participant[]
}

model Participant {
  id               String     @id @default(uuid()) @db.Uuid
  role             Role
  userId           String?    @db.Uuid
  meetingId        String     @db.Uuid
  isVotingEligible Boolean    @default(true)
  user             User?      @relation(fields: [userId], references: [id])
  meeting          Meeting    @relation(fields: [meetingId], references: [id])
  HasVoted         HasVoted[]
}

model Votation {
  id                String        @id @default(uuid()) @db.Uuid
  title             String        @db.VarChar(255)
  description       String
  status            Status        @default(UPCOMING)
  blankVotes        Boolean
  majorityType      MajorityType
  majorityThreshold Int
  meetingId         String        @db.Uuid
  meeting           Meeting       @relation(fields: [meetingId], references: [id])
  alternatives      Alternative[]
  HasVoted          HasVoted[]
}

model HasVoted {
  votationId    String      @db.Uuid
  participantId String      @db.Uuid
  createdAt     DateTime    @default(now())
  votation      Votation    @relation(fields: [votationId], references: [id])
  participant   Participant @relation(fields: [participantId], references: [id])

  @@id([participantId, votationId])
}

model Alternative {
  id         String   @id @default(uuid()) @db.Uuid
  text       String   @db.VarChar(120)
  votationId String   @db.Uuid
  votation   Votation @relation(fields: [votationId], references: [id])
  votes      Vote[]
}

model Vote {
  id            String      @id @default(uuid()) @db.Uuid
  alternative   Alternative @relation(fields: [alternativeId], references: [id])
  alternativeId String      @db.Uuid
  nextVoteId    String?     @db.Uuid
  nextVote      Vote?       @relation("VoteRanking", fields: [nextVoteId], references: [id])
  prevVote      Vote?       @relation("VoteRanking")
}
